<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Covid's Impact of SGDs</title>
		<meta
			name="viewport"
			content="initial-scale=1,maximum-scale=1,user-scalable=no"
		/>
		<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js"></script>
		<script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
		<script src="https://unpkg.com/supercluster@5.0.0/dist/supercluster.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.4.1/chroma.min.js"></script>
		<link
			href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css"
			rel="stylesheet"
		/>
		<link
			href="https://api.mapbox.com/mapbox-assembly/v0.21.1/assembly.min.css"
			rel="stylesheet"
		/>
		<script
			async
			defer
			src="https://api.mapbox.com/mapbox-assembly/v0.21.1/assembly.js"
		></script>
		<style>
			body {
				margin: 0;
				padding: 0;
			}
			#map {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100%;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<div class="select-container" id="select-container">
			<select class="select" id="select-option">
				<option value="particulates">Particulates (mol/m^3)</option>
			</select>
			<div class="select-arrow"></div>
		</div>

		<script>
			mapboxgl.accessToken =
				"pk.eyJ1IjoibWFyYmxldG9hc3QiLCJhIjoiY2thdGwzbmZvMDJnMTJ5bzlzZ2N2dzRoeiJ9.CSGWtvwdfVBHb6YP0kurOw"

			var map = new mapboxgl.Map({
				container: "map",
				style: "mapbox://styles/mapbox/dark-v10",
				center: [0, 50],
				zoom: 2,
			})

			var select_el = document.getElementById("select-option")
			var select_value = select_el.value

			//var before_after = document.getElementById("before-after")
			//var before_after_value = before_after.value

			var clusterRadius
			var clusterMaxZoom
			var propertyToAggregate
			var color
			var currentZoom
			var clusterData

			map.on("load", getData())

			function getData() {
				switch (select_value) {
					case "particulates":
						file = "./april2019.geojson"
						clusterRadius = 5
						clusterMaxZoom = 14
						propertyToAggregate = "COTotalColumn"
						color = ["rgb(145,207,96)", "rgb(255,255,191)", "rgb(255,0,0)"]
					default:
						file = "./april2019.geojson"
						clusterRadius = 5
						clusterMaxZoom = 14
						propertyToAggregate = "COTotalColumn"
						color = ["rgb(145,207,96)", "rgb(255,255,191)", "rgb(255,0,0)"]
				}
				fetch(file)
					.then((result) => result.json())
					.then((json) => {
						geojson_data = json
						cluster.load(geojson_data.features)
						initmap()
					})
					.catch((e) => console.error(e))
			}

			function getFeatureDomain(geojson_data) {
				let data_domain = []
				turf.propEach(geojson_data, function (currentProperties, featureIndex) {
					data_domain.push(
						Math.round((Number(currentProperties["min"]) * 100) / 100)
					)
				})
				return data_domain
			}

			function createDensityStops(stops_domain, scale) {
				let stops = []
				let i = 0.1
				let length = stops_domain.length
				stops_domain.forEach(function (d) {
					stops.push([d, i / length])
					i++
				})
				return stops
			}

			function createRadiusStops(stops_domain, min_radius, max_radius) {
				let stops = []
				let stops_len = stops_domain.length
				let count = 1
				stops_domain.forEach(function (d) {
					stops.push([
						d,
						min_radius + (count / stops_len) * (max_radius - min_radius),
					])
					count += 1
				})
				return stops
			}

			function createColorStops(stops_domain, scale) {
				let stops = []
				stops_domain.forEach(function (d) {
					stops.push([d, scale(d).hex()])
				})
				return stops
			}

			var cluster = new Supercluster({
				radius: clusterRadius,
				maxZoom: clusterMaxZoom,
				initial: function () {
					return {
						count: 0,
						sum: 0,
						min: Infinity,
						max: -Infinity,
					}
				},
				map: function (properties) {
					return {
						count: 1,
						sum: Number(properties[propertyToAggregate]),
						min: Number(properties[propertyToAggregate]),
						max: Number(properties[propertyToAggregate]),
					}
				},
				reduce: function (accumulated, properties) {
					accumulated.sum += Math.round(properties.sum * 100) / 100
					accumulated.count += properties.count
					accumulated.min =
						Math.round(Math.min(accumulated.min, properties.min) * 100) / 100
					accumulated.max =
						Math.round(Math.max(accumulated.max, properties.max) * 100) / 100
					accumulated.avg =
						Math.round((100 * accumulated.sum) / accumulated.count) / 100
				},
			})

			function updateClusters(repaint) {
				currentZoom = map.getZoom()
				clusterData = turf.featureCollection(
					cluster.getClusters([-180, -90, 180, 90], Math.floor(currentZoom))
				)

				let stops_domain = chroma.limits(getFeatureDomain(clusterData), "e", 8)

				var scale = chroma.scale(color).domain(stops_domain).mode("lab")

				colorStops = createColorStops(stops_domain, scale)
				radiusStops = createRadiusStops(stops_domain, 0, 25)

				if (repaint) {
					map.setPaintProperty("clusters", "circle-color", {
						property: "avg",
						stops: colorStops,
					})

					map.setPaintProperty("clusters", "circle-radius", {
						property: "avg",
						stops: radiusStops,
					})

					map.setPaintProperty("unclustered-point", "circle-color", {
						property: propertyToAggregate,
						stops: colorStops,
					})

					map.setPaintProperty("unclustered-point", "circle-radius", {
						property: propertyToAggregate,
						stops: radiusStops,
					})
				}
			}

			function initmap() {
				updateClusters(false)

				select_el.addEventListener("change", function (e) {
					select_value = select_el.value
					updateClusters(true)
				})

				map.addSource("particulatesApril19", {
					type: "geojson",
					data: clusterData,
					buffer: 0,
				})

				map.addLayer(
					{
						id: "clusters_particulatesApril19",
						type: "circle",
						source: "particulatesApril19",
						filter: ["has", "point_count"],
						maxzoom: 15,
						paint: {
							"circle-color": {
								property: "avg",
								stops: colorStops,
							},
							"circle-blur": [
								"case",
								["==", ["feature-state", "hover"], 1],
								0,
								0.55,
							],
							"circle-stroke-width": [
								"case",
								["==", ["feature-state", "hover"], 1],
								1.5,
								0,
							],
							"circle-stroke-color": [
								"case",
								["==", ["feature-state", "hover"], 1],
								"white",
								"rgba(0,0,0,0)",
							],
							"circle-radius": {
								property: "avg",
								type: "interval",
								stops: radiusStops,
							},
						},
					},
					"waterway-label"
				)

				map.addLayer(
					{
						id: "unclustered_particulatesApril19",
						type: "circle",
						source: "particulatesApril19",
						filter: ["!has", "point_count"],
						minzoom: 14,
						paint: {
							"circle-color": {
								property: propertyToAggregate,
								stops: colorStops,
							},
							"circle-radius": {
								property: propertyToAggregate,
								stops: radiusStops,
							},
							"circle-stroke-width": 1,
							"circle-stroke-color": "#fff",
							"circle-opacity": {
								stops: [
									[0, 0],
									[14, 0],
									[15, 1],
								],
							},
						},
					},
					"waterway-label"
				)
			}
		</script>
	</body>
</html>
