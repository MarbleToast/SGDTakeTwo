<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Covid's Impact of SGDs</title>
		<meta
			name="viewport"
			content="initial-scale=1,maximum-scale=1,user-scalable=no"
		/>
		<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js"></script>
		<script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
		<script src="https://unpkg.com/supercluster@5.0.0/dist/supercluster.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.4.1/chroma.min.js"></script>
		<link
			href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css"
			rel="stylesheet"
		/>
		<link
			href="https://api.mapbox.com/mapbox-assembly/v0.21.1/assembly.min.css"
			rel="stylesheet"
		/>
		<script
			async
			defer
			src="https://api.mapbox.com/mapbox-assembly/v0.21.1/assembly.js"
		></script>
		<style>
			body {
				margin: 0;
				padding: 0;
			}
			#map {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100%;
			}
			.fixed {
				position: fixed;
				z-index: 999;
				top: 10px;
				left: 10px;
			}
			#menu {
				background: #fff;
				position: absolute;
				z-index: 1;
				top: 10px;
				right: 10px;
				border-radius: 3px;
				width: 120px;
				border: 1px solid rgba(0, 0, 0, 0.4);
				font-family: "Open Sans", sans-serif;
			}

			#menu a {
				font-size: 13px;
				color: #404040;
				display: block;
				margin: 0;
				padding: 0;
				padding: 10px;
				text-decoration: none;
				border-bottom: 1px solid rgba(0, 0, 0, 0.25);
				text-align: center;
			}

			#menu a:last-child {
			}

			#menu a:hover {
				background-color: #f8f8f8;
				color: #404040;
			}

			#menu a.active {
				background-color: #3887be;
				color: #ffffff;
			}

			#menu a.active:hover {
				background: #3074a4;
			}

			#selection {
				background: #fff;
				position: absolute;
				z-index: 1;
				top: 10px;
				left: 10px;
				border-radius: 3px;
				width: 120px;
				border: 1px solid rgba(0, 0, 0, 0.4);
				font-family: "Open Sans", sans-serif;
			}

			#selection b {
				font-size: 13px;
				color: #404040;
				display: block;
				margin: 0;
				padding: 0;
				padding: 0px;
				text-decoration: none;
				border-bottom: 1px solid rgba(0, 0, 0, 0.25);
				text-align: center;
			}

			#selection b:last-child {
			}

			#selection b:hover {
				background-color: #f8f8f8;
				color: #404040;
			}

			#selection b.active {
				background-color: #3887be;
				color: #ffffff;
			}

			#selection b.active:hover {
				background: #3074a4;
			}
		</style>
	</head>
	<body>
		<nav id="selection"></nav>
		<nav id="menu"></nav>
		<div id="map"></div>

		<script>
			var toggleableSGDIds = ["Particulates", "SGD2"]
			var toggleableLayerIds = [
				["April 2019 Particulates", "April 2020 Particulates"],
				["Before2"],
			]

			var datasets = {
				Particulates: {
					"April 2019 Particulates":
						"./datasets/particulates/april2019.geojson",
					"April 2020 Particulates":
						"./datasets/particulates/april2019.geojson",
				},
			}

			for (var i = 0; i < toggleableSGDIds.length; i++) {
				var id = toggleableSGDIds[i]

				var link = document.createElement("b")
				link.href = "#"
				link.className = "active"
				link.textContent = id

				link.onclick = function (e) {
					var clickedLayer = this.textContent
					e.preventDefault()
					e.stopPropagation()

					var index = toggleableSGDIds.indexOf(clickedLayer)
					document.getElementById("menu").innerHTML = ""

					changeOptions(toggleableLayerIds[index])
				}
				var sel = document.getElementById("selection")
				sel.appendChild(link)
			}

			changeOptions = function (toggleableLayerIds) {
				for (var i = 0; i < toggleableLayerIds.length; i++) {
					var id = toggleableLayerIds[i]

					var link = document.createElement("a")
					link.href = "#"
					link.className = "active"
					link.textContent = id

					link.onclick = function (e) {
						var clickedLayer = this.textContent
						e.preventDefault()
						e.stopPropagation()

						var visibility = map.getLayoutProperty(clickedLayer, "visibility")

						if (visibility == "visible") {
							map.setLayoutProperty(clickedLayer, "visibility", "none")
							this.className = ""
						} else {
							this.className = "active"
							map.setLayoutProperty(clickedLayer, "visibility", "visible")
						}
						currentMapVariant = this.textContent
					}

					var layers = document.getElementById("menu")
					layers.appendChild(link)
				}
			}

			changeOptions(toggleableLayerIds[0])

			mapboxgl.accessToken =
				"pk.eyJ1IjoibWFyYmxldG9hc3QiLCJhIjoiY2thdGwzbmZvMDJnMTJ5bzlzZ2N2dzRoeiJ9.CSGWtvwdfVBHb6YP0kurOw"

			var map = new mapboxgl.Map({
				container: "map",
				style: "mapbox://styles/mapbox/dark-v10",
				center: [0, 50],
				zoom: 2,
			})

			var currentMap = "Particulates"
			var currentMapVariant = "April 2019 Particulates"

			var cluster
			var clusterRadius
			var clusterMaxZoom
			var propertyToAggregate
			var color
			var currentZoom
			var clusterData
			var data = {}

			map.on("load", async () => {
				await getData()
			})

			async function getData() {
				Object.keys(datasets).forEach((element) => {
					Object.keys(datasets[element]).forEach(async (key) => {
						result = await fetch(datasets[element][key])
						json = await result.json()
						if (!data[element]) {
							data[element] = {}
						}
						data[element][key] = json
					})
				})
			}

			function createCluster() {
				switch (currentMap) {
					case "Particulates":
						clusterRadius = 5
						clusterMaxZoom = 14
						propertyToAggregate = "COTotalColumn"
						color = ["rgb(145,207,96)", "rgb(255,255,191)", "rgb(255,0,0)"]
					default:
						clusterRadius = 5
						clusterMaxZoom = 14
						propertyToAggregate = "COTotalColumn"
						color = ["rgb(145,207,96)", "rgb(255,255,191)", "rgb(255,0,0)"]
				}

				console.log(currentMap)
				console.log(currentMapVariant)
				console.log(data)

				geojson_data = data[currentMap][currentMapVariant]

				cluster = new Supercluster({
					radius: clusterRadius,
					maxZoom: clusterMaxZoom,
					initial: function () {
						return {
							count: 0,
							sum: 0,
							min: Infinity,
							max: -Infinity,
						}
					},
					map: function (properties) {
						return {
							count: 1,
							sum: Number(properties[propertyToAggregate]),
							min: Number(properties[propertyToAggregate]),
							max: Number(properties[propertyToAggregate]),
						}
					},
					reduce: function (accumulated, properties) {
						accumulated.sum += Math.round(properties.sum * 100) / 100
						accumulated.count += properties.count
						accumulated.min =
							Math.round(Math.min(accumulated.min, properties.min) * 100) / 100
						accumulated.max =
							Math.round(Math.max(accumulated.max, properties.max) * 100) / 100
						accumulated.avg =
							Math.round((100 * accumulated.sum) / accumulated.count) / 100
					},
				})

				cluster.load(geojson_data.features)
				initmap()
			}

			function getFeatureDomain(geojson_data) {
				let data_domain = []
				turf.propEach(geojson_data, function (currentProperties, featureIndex) {
					data_domain.push(
						Math.round((Number(currentProperties["min"]) * 100) / 100)
					)
				})
				return data_domain
			}

			function createDensityStops(stops_domain, scale) {
				let stops = []
				let i = 0.1
				let length = stops_domain.length
				stops_domain.forEach(function (d) {
					stops.push([d, i / length])
					i++
				})
				return stops
			}

			function createRadiusStops(stops_domain, min_radius, max_radius) {
				let stops = []
				let stops_len = stops_domain.length
				let count = 1
				stops_domain.forEach(function (d) {
					stops.push([
						d,
						min_radius + (count / stops_len) * (max_radius - min_radius),
					])
					count += 1
				})
				return stops
			}

			function createColorStops(stops_domain, scale) {
				let stops = []
				stops_domain.forEach(function (d) {
					stops.push([d, scale(d).hex()])
				})
				return stops
			}

			function updateClusters(repaint) {
				currentZoom = map.getZoom()
				clusterData = turf.featureCollection(
					cluster.getClusters([-180, -90, 180, 90], Math.floor(currentZoom))
				)

				let stops_domain = chroma.limits(getFeatureDomain(clusterData), "e", 8)

				var scale = chroma.scale(color).domain(stops_domain).mode("lab")

				colorStops = createColorStops(stops_domain, scale)
				radiusStops = createRadiusStops(stops_domain, 0, 25)

				if (repaint) {
					map.setPaintProperty("clusters", "circle-color", {
						property: "avg",
						stops: colorStops,
					})

					map.setPaintProperty("clusters", "circle-radius", {
						property: "avg",
						stops: radiusStops,
					})

					map.setPaintProperty("unclustered-point", "circle-color", {
						property: propertyToAggregate,
						stops: colorStops,
					})

					map.setPaintProperty("unclustered-point", "circle-radius", {
						property: propertyToAggregate,
						stops: radiusStops,
					})
				}
			}

			function initmap() {
				updateClusters(false)

				map.addSource("particulatesApril19", {
					type: "geojson",
					data: clusterData,
					buffer: 0,
				})

				map.addLayer(
					{
						id: "April 2019 Particulates",
						type: "circle",
						source: "particulatesApril19",
						filter: ["has", "point_count"],
						maxzoom: 15,
						paint: {
							"circle-color": {
								property: "avg",
								stops: colorStops,
							},
							"circle-blur": [
								"case",
								["==", ["feature-state", "hover"], 1],
								0,
								0.55,
							],
							"circle-stroke-width": [
								"case",
								["==", ["feature-state", "hover"], 1],
								1.5,
								0,
							],
							"circle-stroke-color": [
								"case",
								["==", ["feature-state", "hover"], 1],
								"white",
								"rgba(0,0,0,0)",
							],
							"circle-radius": {
								property: "avg",
								type: "interval",
								stops: radiusStops,
							},
						},
					},
					"waterway-label"
				)

				map.addLayer(
					{
						id: "unclustered_particulatesApril19",
						type: "circle",
						source: "particulatesApril19",
						filter: ["!has", "point_count"],
						minzoom: 14,
						paint: {
							"circle-color": {
								property: propertyToAggregate,
								stops: colorStops,
							},
							"circle-radius": {
								property: propertyToAggregate,
								stops: radiusStops,
							},
							"circle-stroke-width": 1,
							"circle-stroke-color": "#fff",
							"circle-opacity": {
								stops: [
									[0, 0],
									[14, 0],
									[15, 1],
								],
							},
						},
					},
					"waterway-label"
				)
			}
		</script>
	</body>
</html>
